# Kvizovka - Bug Fixes and Features (Session Summary)

## Date
2026-01-02

## Overview
This document summarizes critical bug fixes and the implementation of the challenge system for Kvizovka.

---

## üêõ Bug Fixes

### 1. Word Validation Bug - "Invalid words: E (Word too short)"

**Problem:**
When placing words that reuse letters from existing words (e.g., placing "STEN" vertically using "E" from horizontal "POEN"), the validator incorrectly reported single-letter words as invalid.

**Root Causes:**

#### Issue A: Word Extraction After Tile Removal
**Location:** `src/game-engine/MoveValidator.ts:147-197`

**Problem:**
```typescript
// BEFORE (BROKEN):
const mainWord = this.findMainWord(placedTiles, direction)  // Returns BoardSquare[] references

// Remove temporary tiles
for (const placed of placedTiles) {
  this.board.removeTile(placed.row, placed.col)  // ‚ùå Tiles removed!
}

// Validate
const invalidWords = this.wordValidator.getInvalidWords([mainWord])  // ‚ùå Reads null tiles!
```

`mainWord` is an array of **references** to BoardSquare objects. When tiles were removed from the board, those squares now had `tile = null`. When `extractWordFromSquares` tried to read the letters, it only found the existing tile "E" (which wasn't removed), resulting in the error "E (Word too short)".

**Solution:**
Extract the word text **before** removing temporary tiles:
```typescript
// AFTER (FIXED):
const mainWord = this.findMainWord(placedTiles, direction)

// Extract word BEFORE removing tiles (while references are still valid)
const wordText = this.wordValidator.extractWordFromSquares(mainWord)

// Now remove tiles
for (const placed of placedTiles) {
  this.board.removeTile(placed.row, placed.col)
}

// Validate using the extracted text
const validationResult = this.wordValidator.validateWord(wordText)
```

#### Issue B: Blocker Tiles Not Stopping Word Scans
**Location:** `src/game-engine/Board.ts:253-296`

**Problem:**
`getTilesInLine()` was treating blocker tiles as regular tiles and scanning through them, when it should **stop at blockers** since they mark word boundaries.

```typescript
// BEFORE (BROKEN):
while (startCol > 0 && !this.isEmpty(row, startCol - 1)) {
  startCol--  // ‚ùå Continues through blockers!
}
```

**Solution:**
Stop scanning when encountering empty squares **OR** blocker tiles:
```typescript
// AFTER (FIXED):
while (startCol > 0 && !this.isEmpty(row, startCol - 1) && !this.isBlocker(row, startCol - 1)) {
  startCol--  // ‚úÖ Stops at blockers
}
```

Applied to all four scan directions (left, right, up, down).

#### Issue C: Cross-Word Validation (Scrabble-Style)
**Location:** `src/game-engine/MoveValidator.ts:147-205`

**Problem:**
The validator was checking ALL words formed (main word + perpendicular cross-words), like in Scrabble. This caused it to validate single letters at intersections.

**Solution:**
In Kvizovka, only validate the **main word being played**. Cross-words are already validated from previous turns:
```typescript
// BEFORE (BROKEN):
const wordsFormed = this.findAllWordsFormed(placedTiles, direction)  // Main + cross-words
const invalidWords = this.wordValidator.getInvalidWords(wordsFormed)

// AFTER (FIXED):
const mainWord = this.findMainWord(placedTiles, direction)  // ONLY main word
const wordText = this.wordValidator.extractWordFromSquares(mainWord)
const validationResult = this.wordValidator.validateWord(wordText)
```

**Files Changed:**
- `src/game-engine/MoveValidator.ts` (lines 147-205)
- `src/game-engine/Board.ts` (lines 253-296)

---

## ‚ú® New Feature: Challenge System

### 2. Automatic Dictionary Validation Removed

**Game Rule:**
In Kvizovka, words are **not** automatically validated against the dictionary when played. Instead, the opponent can **challenge** the word after it's been played.

**Changes:**

#### MoveValidator - Removed Dictionary Checks
**Location:** `src/game-engine/MoveValidator.ts:189-197`

**Before:**
```typescript
// Rule 6: Main word must be valid
const validationResult = this.wordValidator.validateWord(wordText)

if (!validationResult.isValid) {
  return {
    isValid: false,
    reason: `Invalid word: ${validationResult.word} (${validationResult.reason})`,
  }
}
```

**After:**
```typescript
// Rule 6: Check minimum word length
// NOTE: Dictionary validation is NOT automatic in Kvizovka!
// Words can only be challenged by the opponent after being played.
if (wordText.length < MIN_WORD_LENGTH) {
  return {
    isValid: false,
    reason: `Word must be at least ${MIN_WORD_LENGTH} letters long`,
  }
}
```

**Result:** Words are now accepted based only on:
- ‚úÖ Minimum 4-letter length
- ‚úÖ Forms a valid line (horizontal/vertical)
- ‚úÖ Connects to existing tiles
- ‚úÖ First move touches center
- ‚ùå ~~Dictionary validation~~ (removed - only via challenge)

### 3. Challenge Mechanism Implementation

#### Game Store State
**Location:** `src/store/gameStore.ts:75-82`

**Added State:**
```typescript
/**
 * Last played word (can be challenged by opponent)
 */
lastPlayedWord: {
  word: string
  playerIndex: number
  moveIndex: number
} | null
```

**Purpose:** Tracks the most recent word so the opponent can challenge it.

#### MoveValidator Enhancement
**Location:** `src/game-engine/MoveValidator.ts:27-52`

**Added to Result:**
```typescript
export interface MoveValidationResult {
  // ... existing fields

  /**
   * The word text (for challenges)
   */
  wordText?: string
}
```

**Returns word text** so the game store can save it for challenges.

#### Challenge Action
**Location:** `src/store/gameStore.ts:594-651`

**New Action:**
```typescript
challengeLastWord: () => { success: boolean; word: string; reason: string } | null
```

**Logic:**
1. Get `lastPlayedWord` from state
2. Validate word against dictionary using `WordValidator`
3. **If challenge succeeds** (word is invalid):
   - TODO: Undo the move (remove tiles, restore hand, revert score)
   - Clear `lastPlayedWord`
4. **If challenge fails** (word is valid):
   - Penalize challenger: `timeRemaining -= 180` (3 minutes)
   - Clear `lastPlayedWord`
   - Update game state

#### Time Penalty
**Location:** `src/store/gameStore.ts:635-636`

**Implementation:**
```typescript
// Penalize challenger by reducing their time by 3 minutes (180 seconds)
const currentPlayer = game.players[game.currentPlayerIndex]
currentPlayer.timeRemaining = Math.max(0, currentPlayer.timeRemaining - 180)
```

**Notes:**
- Penalty is exactly **3 minutes** (180 seconds)
- Time cannot go below 0 (`Math.max(0, ...)`)
- Applies to the **current player** (the challenger, not the word player)

### 4. Challenge Button UI

**Location:** `src/components/GameControls/GameControls.tsx:130-173, 193-201`

**Added UI Component:**
```tsx
{canChallenge && (
  <button
    onClick={handleChallenge}
    className="btn text-lg py-4 font-bold bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white shadow-lg animate-pulse"
  >
    ‚ö†Ô∏è Challenge Word: "{lastPlayedWord.word}"
  </button>
)}
```

**Features:**
- **Visibility:** Only shown when opponent just played a word (`canChallenge = lastPlayedWord && isInProgress`)
- **Styling:**
  - Orange-to-red gradient (warning colors)
  - Pulsing animation to draw attention
  - Large, prominent button
- **Confirmation Dialog:**
  ```
  Challenge the word "STEN"?

  ‚ö†Ô∏è Warning: If the word is valid, you will lose 3 minutes from your time!
  ```
- **Result Dialogs:**
  - **Success:** "‚úÖ Challenge successful! The word 'X' is invalid. Reason: Y. The move has been undone."
  - **Failure:** "‚ùå Challenge failed! The word 'X' is valid. You have been penalized 3 minutes."

**Behavior:**
- Button appears immediately after opponent plays a word
- Disappears after:
  - Challenge is made (successful or failed)
  - Current player plays their own word
  - Game is paused/ended

**Files Changed:**
- `src/store/gameStore.ts` (state, actions, imports)
- `src/game-engine/MoveValidator.ts` (result interface, validation logic)
- `src/components/GameControls/GameControls.tsx` (UI, handlers)

---

## üìä Technical Details

### Validation Flow (Before vs After)

**BEFORE (Automatic Validation):**
```
Player places tiles
  ‚Üì
Validate structure (line, connectivity, length)
  ‚Üì
Validate DICTIONARY ‚Üê ‚ùå Automatic
  ‚Üì
Accept/Reject
```

**AFTER (Challenge-Based):**
```
Player places tiles
  ‚Üì
Validate structure (line, connectivity, length)
  ‚Üì
Accept (no dictionary check)
  ‚Üì
Opponent can challenge
  ‚Üì
IF challenged ‚Üí Validate DICTIONARY
  ‚Üì
Success: Undo move
Failure: Penalize challenger -3 min
```

### Debug Logging Added

**Location:** `src/game-engine/MoveValidator.ts:147-182`

**Logs:**
```typescript
console.log('üîç Move Validation:', {
  placedTilesCount: placedTiles.length,
  positions: placedTiles.map(t => `(${t.row},${t.col})`).join(', '),
  letters: placedTiles.map(t => /* extract letter */).join(''),
  direction: direction
})

console.log('üìù Found main word:', {
  length: mainWord.length,
  word: wordText
})
```

**Purpose:** Helps diagnose validation issues during development.

---

## üîß Known Issues / TODOs

### 1. Successful Challenge - Move Undo Not Implemented
**Location:** `src/store/gameStore.ts:625-631`

**Current State:**
```typescript
if (result.success) {
  // Challenge successful - word is invalid
  // TODO: Undo the last move (remove tiles, restore player's hand, revert score)
  console.log('Challenge successful! Word was invalid:', lastPlayedWord.word)

  // Clear the last played word
  set({ lastPlayedWord: null })
}
```

**What's Missing:**
When a challenge succeeds, we need to:
1. Remove tiles from board
2. Restore tiles to player's hand
3. Revert player's score
4. Remove move from history
5. Switch turn back to original player
6. Remove blocker tiles placed around the word

**Priority:** High - This is core functionality for the challenge system.

### 2. Debug Logging in Production
**Location:** `src/game-engine/MoveValidator.ts:147-182`

**Issue:** Console logs are enabled in production build.

**Solution:** Wrap in `if (process.env.NODE_ENV === 'development')` or remove before release.

---

## üìù Testing Checklist

- [x] Place word vertically using letter from horizontal word ‚Üí No "Word too short" error
- [x] Place word horizontally using letter from vertical word ‚Üí No "Word too short" error
- [x] Blocker tiles prevent word extension ‚Üí Words stop at blockers
- [x] Invalid words accepted without challenge ‚Üí Words placed successfully
- [x] Challenge valid word ‚Üí Challenger loses 3 minutes
- [ ] Challenge invalid word ‚Üí Move undone, tiles returned (TODO)
- [x] Challenge button appears after opponent plays word
- [x] Challenge button disappears after challenge or next move
- [x] Time penalty applied correctly (exactly 180 seconds)

---

## üéØ Summary

**What Was Fixed:**
1. ‚úÖ Word validation bug causing false "Word too short" errors
2. ‚úÖ getTilesInLine now respects blocker tile boundaries
3. ‚úÖ Only main word validated (not cross-words)
4. ‚úÖ Word extraction happens before tile removal

**What Was Added:**
1. ‚úÖ Challenge system (no automatic dictionary validation)
2. ‚úÖ Challenge button UI with confirmation dialogs
3. ‚úÖ 3-minute time penalty for failed challenges
4. ‚úÖ lastPlayedWord state tracking
5. ‚úÖ Debug logging for move validation

**What Still Needs Work:**
1. ‚ùå Full move undo when challenge succeeds
2. ‚ùå Remove debug logs from production build

**Build Status:** ‚úÖ Successful (186.93 KB)

---

## üì¶ Files Modified

### Game Engine
- `src/game-engine/MoveValidator.ts` - Validation logic, word extraction fix, challenge support
- `src/game-engine/Board.ts` - Blocker boundary detection in getTilesInLine

### State Management
- `src/store/gameStore.ts` - Challenge mechanism, lastPlayedWord state, time penalty

### UI Components
- `src/components/GameControls/GameControls.tsx` - Challenge button, handlers, dialogs

### Total Lines Changed
- **Added:** ~120 lines
- **Modified:** ~60 lines
- **Deleted:** ~30 lines (removed cross-word validation)
